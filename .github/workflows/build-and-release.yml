name: Build and Release

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]
  release:
    types: [ created ]

jobs:
  build:
    runs-on: windows-latest  # ä½¿ç”¨æœ€æ–°çš„Windowsç¯å¢ƒ (å½“å‰: Windows Server 2022, 2025å¹´9æœˆå: Windows Server 2025)
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Set up Python 3.11
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'
        
    - name: Cache pip dependencies
      uses: actions/cache@v3
      with:
        path: ~\AppData\Local\pip\Cache
        key: ${{ runner.os }}-pip-${{ hashFiles('**/requirements.txt') }}
        restore-keys: |
          ${{ runner.os }}-pip-
          
    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
        pip install pyinstaller
        
    - name: Set up environment for UTF-8
      run: |
        # è®¾ç½®ç¯å¢ƒå˜é‡ä»¥æ”¯æŒUTF-8ç¼–ç 
        echo "PYTHONIOENCODING=utf-8" >> $env:GITHUB_ENV
        echo "PYTHONUTF8=1" >> $env:GITHUB_ENV
        # è®¾ç½®æ§åˆ¶å°ä»£ç é¡µä¸ºUTF-8
        chcp 65001
      shell: powershell
        
    - name: Build executable
      run: |
        python ci_build_exe.py
      env:
        PYTHONIOENCODING: utf-8
        PYTHONUTF8: 1
        
    - name: List dist contents (debug)
      run: |
        Write-Host "Contents of dist directory:"
        if (Test-Path "dist") {
          Get-ChildItem -Path "dist" -Recurse | Format-Table -AutoSize
        } else {
          Write-Host "dist directory not found"
        }
      shell: powershell
        
    - name: Upload build artifacts
      uses: actions/upload-artifact@v4
      with:
        name: scanman-windows-build
        path: |
          dist/æ¼æ´æ‰«ææŠ¥å‘Šç”Ÿæˆå™¨.exe
          dist/static/
          dist/README.md
        retention-days: 30
        
    - name: Create release archive
      if: github.event_name == 'push' && github.ref == 'refs/heads/main'
      shell: powershell
      run: |
        Write-Output "Creating release package..."
        New-Item -ItemType Directory -Name "release-package" -Force | Out-Null
        
        Write-Output "Copying executable..."
        Copy-Item -Path "dist\æ¼æ´æ‰«ææŠ¥å‘Šç”Ÿæˆå™¨.exe" -Destination "release-package\" -Force
        
        Write-Output "Copying static folder..."
        if (Test-Path "dist\static") {
          Copy-Item -Path "dist\static" -Destination "release-package\static" -Recurse -Force
        } else {
          Write-Output "Warning: static folder not found"
        }
        
        Write-Output "Copying README..."
        if (Test-Path "dist\README.md") {
          Copy-Item -Path "dist\README.md" -Destination "release-package\" -Force
        } else {
          Write-Output "README.md not found, skipping"
        }
        
        Write-Output "Creating zip archive..."
        $sourcePath = "release-package\*"
        $destPath = "scanman-windows-latest.zip"
        Compress-Archive -Path $sourcePath -DestinationPath $destPath -Force
        
        Write-Output "Release package created successfully"
        
    - name: Get current date
      if: github.event_name == 'push' && github.ref == 'refs/heads/main'
      id: date
      run: echo "date=$(Get-Date -Format 'yyyy-MM-dd-HHmm')" >> $env:GITHUB_OUTPUT
      shell: powershell
      
    - name: Create Release
      if: github.event_name == 'push' && github.ref == 'refs/heads/main'
      id: create_release
      uses: actions/create-release@v1
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      with:
        tag_name: v${{ steps.date.outputs.date }}
        release_name: æ¼æ´æ‰«ææŠ¥å‘Šç”Ÿæˆå™¨ v${{ steps.date.outputs.date }}
        body: |
          ## ğŸš€ è‡ªåŠ¨æ„å»ºå‘å¸ƒ
          
          **æ„å»ºæ—¶é—´**: ${{ steps.date.outputs.date }}
          **æäº¤**: ${{ github.sha }}
          **åˆ†æ”¯**: ${{ github.ref_name }}
          
           ### ğŸ“¦ åŒ…å«å†…å®¹
           - `æ¼æ´æ‰«ææŠ¥å‘Šç”Ÿæˆå™¨.exe` - ä¸»ç¨‹åºå¯æ‰§è¡Œæ–‡ä»¶
           - `static/` - Wordæ¨¡æ¿æ–‡ä»¶å¤¹ï¼ˆå¿…éœ€ï¼‰
           - `README.md` - ä½¿ç”¨è¯´æ˜
          
          ### ğŸ”§ ä½¿ç”¨æ–¹æ³•
          1. ä¸‹è½½å¹¶è§£å‹ `scanman-windows-latest.zip`
          2. åŒå‡»è¿è¡Œ `æ¼æ´æ‰«ææŠ¥å‘Šç”Ÿæˆå™¨.exe`
          3. æŒ‰ç…§GUIç•Œé¢æç¤ºæ“ä½œ
          
          ---
          *æ­¤ç‰ˆæœ¬ç”± GitHub Actions è‡ªåŠ¨æ„å»º*
        draft: false
        prerelease: false
        
    - name: Upload Release Asset
      if: github.event_name == 'push' && github.ref == 'refs/heads/main'
      uses: actions/upload-release-asset@v1
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      with:
        upload_url: ${{ steps.create_release.outputs.upload_url }}
        asset_path: ./scanman-windows-latest.zip
        asset_name: scanman-windows-latest.zip
        asset_content_type: application/zip

  # å¯é€‰ï¼šåœ¨PRæ—¶è¿›è¡Œæ„å»ºæµ‹è¯•ï¼ˆä¸å‘å¸ƒï¼‰
  test-build:
    runs-on: windows-latest  # å½“å‰: Windows Server 2022, 2025å¹´9æœˆå: Windows Server 2025
    if: github.event_name == 'pull_request'
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Set up Python 3.11
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'
        
    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
        pip install pyinstaller
        
    - name: Set up environment for UTF-8
      run: |
        # è®¾ç½®ç¯å¢ƒå˜é‡ä»¥æ”¯æŒUTF-8ç¼–ç 
        echo "PYTHONIOENCODING=utf-8" >> $env:GITHUB_ENV
        echo "PYTHONUTF8=1" >> $env:GITHUB_ENV
        # è®¾ç½®æ§åˆ¶å°ä»£ç é¡µä¸ºUTF-8
        chcp 65001
      shell: powershell
        
    - name: Test build
      run: |
        python ci_build_exe.py
      env:
        PYTHONIOENCODING: utf-8
        PYTHONUTF8: 1
        
    - name: Verify build
      run: |
        if (Test-Path "dist\æ¼æ´æ‰«ææŠ¥å‘Šç”Ÿæˆå™¨.exe") {
          echo "âœ… Build successful - executable created"
          $size = (Get-Item "dist\æ¼æ´æ‰«ææŠ¥å‘Šç”Ÿæˆå™¨.exe").Length / 1MB
          echo "ğŸ“Š Executable size: $([math]::Round($size, 2)) MB"
        } else {
          echo "âŒ Build failed - executable not found"
          exit 1
        }
        
        if (Test-Path "dist\static") {
          $templateCount = (Get-ChildItem "dist\static\*.docx").Count
          echo "ğŸ“„ Template files found: $templateCount"
        } else {
          echo "âš ï¸ Warning: static folder not found"
        }
      shell: powershell
