name: Build and Release

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]
  release:
    types: [ created ]

jobs:
  build:
    runs-on: windows-latest  # 使用最新的Windows环境 (当前: Windows Server 2022, 2025年9月后: Windows Server 2025)
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Set up Python 3.11
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'
        
    - name: Cache pip dependencies
      uses: actions/cache@v3
      with:
        path: ~\AppData\Local\pip\Cache
        key: ${{ runner.os }}-pip-${{ hashFiles('**/requirements.txt') }}
        restore-keys: |
          ${{ runner.os }}-pip-
          
    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
        pip install pyinstaller
        
    - name: Set up environment for UTF-8
      run: |
        # 设置环境变量以支持UTF-8编码
        echo "PYTHONIOENCODING=utf-8" >> $env:GITHUB_ENV
        echo "PYTHONUTF8=1" >> $env:GITHUB_ENV
        # 设置控制台代码页为UTF-8
        chcp 65001
      shell: powershell
        
    - name: Build executable
      run: |
        python ci_build_exe.py
      env:
        PYTHONIOENCODING: utf-8
        PYTHONUTF8: 1
        
    - name: List dist contents (debug)
      run: |
        Write-Host "Contents of dist directory:"
        if (Test-Path "dist") {
          Get-ChildItem -Path "dist" -Recurse | Format-Table -AutoSize
        } else {
          Write-Host "dist directory not found"
        }
      shell: powershell
        
    - name: Upload build artifacts
      uses: actions/upload-artifact@v4
      with:
        name: scanman-windows-build
        path: |
          dist/漏洞扫描报告生成器.exe
          dist/static/
          dist/README.md
        retention-days: 30
        
    - name: Create release archive
      if: github.event_name == 'push' && github.ref == 'refs/heads/main'
      shell: powershell
      run: |
        Write-Output "Creating release package..."
        New-Item -ItemType Directory -Name "release-package" -Force | Out-Null
        
        Write-Output "Copying executable..."
        Copy-Item -Path "dist\漏洞扫描报告生成器.exe" -Destination "release-package\" -Force
        
        Write-Output "Copying static folder..."
        if (Test-Path "dist\static") {
          Copy-Item -Path "dist\static" -Destination "release-package\static" -Recurse -Force
        } else {
          Write-Output "Warning: static folder not found"
        }
        
        Write-Output "Copying README..."
        if (Test-Path "dist\README.md") {
          Copy-Item -Path "dist\README.md" -Destination "release-package\" -Force
        } else {
          Write-Output "README.md not found, skipping"
        }
        
        Write-Output "Creating zip archive..."
        $sourcePath = "release-package\*"
        $destPath = "scanman-windows-latest.zip"
        Compress-Archive -Path $sourcePath -DestinationPath $destPath -Force
        
        Write-Output "Release package created successfully"
        
    - name: Get current date
      if: github.event_name == 'push' && github.ref == 'refs/heads/main'
      id: date
      run: echo "date=$(Get-Date -Format 'yyyy-MM-dd-HHmm')" >> $env:GITHUB_OUTPUT
      shell: powershell
      
    - name: Create Release
      if: github.event_name == 'push' && github.ref == 'refs/heads/main'
      id: create_release
      uses: actions/create-release@v1
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      with:
        tag_name: v${{ steps.date.outputs.date }}
        release_name: 漏洞扫描报告生成器 v${{ steps.date.outputs.date }}
        body: |
          ## 🚀 自动构建发布
          
          **构建时间**: ${{ steps.date.outputs.date }}
          **提交**: ${{ github.sha }}
          **分支**: ${{ github.ref_name }}
          
           ### 📦 包含内容
           - `漏洞扫描报告生成器.exe` - 主程序可执行文件
           - `static/` - Word模板文件夹（必需）
           - `README.md` - 使用说明
          
          ### 🔧 使用方法
          1. 下载并解压 `scanman-windows-latest.zip`
          2. 双击运行 `漏洞扫描报告生成器.exe`
          3. 按照GUI界面提示操作
          
          ---
          *此版本由 GitHub Actions 自动构建*
        draft: false
        prerelease: false
        
    - name: Upload Release Asset
      if: github.event_name == 'push' && github.ref == 'refs/heads/main'
      uses: actions/upload-release-asset@v1
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      with:
        upload_url: ${{ steps.create_release.outputs.upload_url }}
        asset_path: ./scanman-windows-latest.zip
        asset_name: scanman-windows-latest.zip
        asset_content_type: application/zip

  # 可选：在PR时进行构建测试（不发布）
  test-build:
    runs-on: windows-latest  # 当前: Windows Server 2022, 2025年9月后: Windows Server 2025
    if: github.event_name == 'pull_request'
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Set up Python 3.11
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'
        
    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
        pip install pyinstaller
        
    - name: Set up environment for UTF-8
      run: |
        # 设置环境变量以支持UTF-8编码
        echo "PYTHONIOENCODING=utf-8" >> $env:GITHUB_ENV
        echo "PYTHONUTF8=1" >> $env:GITHUB_ENV
        # 设置控制台代码页为UTF-8
        chcp 65001
      shell: powershell
        
    - name: Test build
      run: |
        python ci_build_exe.py
      env:
        PYTHONIOENCODING: utf-8
        PYTHONUTF8: 1
        
    - name: Verify build
      run: |
        if (Test-Path "dist\漏洞扫描报告生成器.exe") {
          echo "✅ Build successful - executable created"
          $size = (Get-Item "dist\漏洞扫描报告生成器.exe").Length / 1MB
          echo "📊 Executable size: $([math]::Round($size, 2)) MB"
        } else {
          echo "❌ Build failed - executable not found"
          exit 1
        }
        
        if (Test-Path "dist\static") {
          $templateCount = (Get-ChildItem "dist\static\*.docx").Count
          echo "📄 Template files found: $templateCount"
        } else {
          echo "⚠️ Warning: static folder not found"
        }
      shell: powershell
